---
title: "Covid-19 - SMSD models"
output:
  html_document: default
---
  
#### Goal
  
Build up a useful model in order to predict response variable Y starting from data provided.

-   response variable: number of new positives
-   data: Covid-19 spreading outbreak from the official website of Protezione Civile

#### Dataset

Load dataset.

```{r dataset, echo=FALSE, message=FALSE}
df_global <- data.frame(read.csv("https://raw.githubusercontent.com/pcm-dpc/
COVID-19/master/dati-regioni/dpc-covid19-ita-regioni.csv"))

```

#### Clean dataset

Read data we are interested in, then those that are relative to the following couple of parameters:
  
-   regione: Sicilia

-   data: 1st October 2020 to 1st February 2021

```{r df, echo=FALSE, message=FALSE}

df_global <- data.frame(read.csv("https://raw.githubusercontent.com/pcm-dpc/
COVID-19/master/dati-regioni/dpc-covid19-ita-regioni.csv"))


df_sicily_secondwave <- df_global[which(df_global$denominazione_regione == "Sicilia" & 
                                          (df_global$data >= "2020-09-24T10:00:00" & df_global$data <= "2021-02-15T10:00:00")), ]

#adjust number of swabs
df_sicily_secondwave[which(df_sicily_secondwave$data >= "2021-01-15" & df_sicily_secondwave$data <= "2021-02-15"), ]$tamponi <- 
          df_sicily_secondwave[which(df_sicily_secondwave$data >= "2021-01-15" & df_sicily_secondwave$data <= "2021-02-15"), ]$tamponi -
          df_sicily_secondwave[which(df_sicily_secondwave$data >= "2021-01-15" & df_sicily_secondwave$data <= "2021-02-15"),]$tamponi_test_antigenico_rapido

# remove not useful columns
df_extended <- df_sicily_secondwave[ , -which(names(df_sicily_secondwave) %in% c("stato", "codice_regione", "denominazione_regione", "lat", "long", "note"))]
df_extended <- df_extended[ , -c(17:24)]

df_extended$data <- as.Date(df_extended$data,  "%Y-%m-%d")


# add columns accounting for:
df_extended$nuovi_tamponi <-NA
df_extended$nuovi_decessi <-NA
df_extended$nuovi_dimessi <- NA
df_extended$terapia_intensiva_prev <- NA

for(x in 8:nrow(df_extended)) {
  df_extended$nuovi_tamponi[x] <- df_extended$tamponi[x] - df_extended$tamponi[x-1] # the number of new swabs carried out
  df_extended$nuovi_decessi[x] <- df_extended$deceduti[x] - df_extended$deceduti[x-1] # daily deaths
  df_extended$nuovi_dimessi[x] <- df_extended$dimessi_guariti[x] - df_extended$dimessi_guariti[x-1] # variation in the number of people discharged from the hospital
  df_extended$terapia_intensiva_prev[x] <- df_sicily_secondwave$terapia_intensiva[x-7]
}


# remove first row
df_extended <- df_extended[-c(1:7),]

#index reordering
row.names(df_extended) <- NULL 

#add color
df_extended$color <-NA
df_extended$color[1:36]<- "bianco"
df_extended$color[c(37:59,124:137)]<- "arancione"
df_extended$color[c(60:84)]<- "giallo"
df_extended$color[c(85:95,96:100, 101:123)]<- "rosso"

df <- df_extended[1:123,]
df$data <- as.Date(df$data,  "%Y-%m-%d")

library(ggplot2)

ggplot() +
  geom_line(data = df, aes(x = data, y = nuovi_positivi, color="nuovi positivi", group = 1)) +
  geom_point(data = df, aes(x = data, y = nuovi_positivi, color="nuovi positivi", group = 1),col=c("#fc6b03","#cfcaca","#f2d729","#b3190b")[unclass(as.factor(df$color))])+ 
  labs(x = "Time", y = "New positives") +
  scale_x_date(date_breaks = '5 days',
               date_labels = '%Y-%m-%d') +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


```

```{r adjust color, echo=FALSE, message=FALSE, warning=FALSE}
library(ggplot2)

ggplot() +
  geom_line(data = df, aes(x = data, y = nuovi_positivi, color="nuovi positivi", group = 1)) +
  geom_point(data = df, aes(x = data, y = nuovi_positivi, color="nuovi positivi", group = 1),col=c("#fc6b03","#cfcaca","#f2d729","#b3190b")[unclass(as.factor(df$color))])+ 
  labs(x = "Time", y = "New positives") +
  scale_x_date(date_breaks = '5 days',
               date_labels = '%Y-%m-%d') +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

```{r linear models, echo=FALSE, message=FALSE, warning=FALSE}
# Try some linear models to see which are the variables which significantly explain the variability of y
mod1 <- lm(nuovi_positivi ~ terapia_intensiva, data = df)
mod2 <- lm(nuovi_positivi ~ terapia_intensiva + color, data = df)
mod3 <- lm(nuovi_positivi ~ terapia_intensiva * color, data = df)
mod4 <- lm(nuovi_positivi ~ terapia_intensiva * color + data , data = df)

summary(mod1)
summary(mod2)
summary(mod3)
summary(mod4)

ggplot() +
  geom_point(data = df, aes(x = data, y = nuovi_positivi, color="nuovi positivi", group = 1),col=c("#fc6b03","#cfcaca","#f2d729","#b3190b")[unclass(as.factor(df$color))])+ 
geom_line(data = df, aes(x = data, y = predict(mod1), color = "model 1", group = 1)) +
  geom_line(data = df, aes(x = data, y = predict(mod2), color = "model 2", group = 1)) +
  geom_line(data = df, aes(x = data, y = predict(mod3), color = "model 3", group = 1)) +
  geom_line(data = df, aes(x = data, y = predict(mod3), color = "model 4", group = 1)) +

  labs(x = "Time", y = "New positives") +
  scale_x_date(date_breaks = '5 days',
               date_labels = '%Y-%m-%d') +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

```{r glm, echo=FALSE, message=FALSE, warning=FALSE}

gmod1 <- glm(nuovi_positivi ~ terapia_intensiva * color, data = df, family=poisson(link = "log"))
gmod2 <- glm(nuovi_positivi ~ terapia_intensiva * color + data, data = df, family=poisson(link = "log"))

summary(gmod1)
summary(gmod2)

ggplot() +
  geom_point(data = df, aes(x = data, y = nuovi_positivi, color="nuovi positivi", group = 1),col=c("#fc6b03","#cfcaca","#f2d729","#b3190b")[unclass(as.factor(df$color))])+ 
geom_line(data = df, aes(x = data, y = predict(gmod1,type="response"), color = "model 1", group = 1)) +
geom_line(data = df, aes(x = data, y = predict(gmod2,type="response"), color = "model 2", group = 1)) +


  labs(x = "Time", y = "New positives") +
  scale_x_date(date_breaks = '5 days',
               date_labels = '%Y-%m-%d') +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


```


```{r glm mod2 errors, echo =FALSE, message=FALSE, warning=FALSE}
## Model checking - Residual plots
library(modelr)
library(ggplot2)

df$resid <- df$nuovi_positivi -  predict(gmod2,type="response")

ggplot(df, aes(data, resid, colour = color)) + 
  geom_ref_line(h = 0) + 
  geom_line()

df %>% 
  ggplot(aes(data, resid)) + 
  geom_ref_line(h = 0) + 
  geom_line(col=1) + 
  geom_smooth(se = FALSE, span = 0.20, col=3)

```


```{r glm prev data, echo=FALSE, message=FALSE, warning=FALSE}

gmod3 <- glm(nuovi_positivi ~ terapia_intensiva * color + terapia_intensiva_prev, data = df, family=poisson(link = "log"))
gmod4 <- glm(nuovi_positivi ~ terapia_intensiva * color + data + terapia_intensiva_prev, data = df, family=poisson(link = "log"))

summary(gmod3)
summary(gmod4)

ggplot() +
  geom_point(data = df, aes(x = data, y = nuovi_positivi, color="nuovi positivi", group = 1),col=c("#fc6b03","#cfcaca","#f2d729","#b3190b")[unclass(as.factor(df$color))])+ 
geom_line(data = df, aes(x = data, y = predict(gmod3,type="response"), color = "model 3", group = 1)) +
geom_line(data = df, aes(x = data, y = predict(gmod4,type="response"), color = "model 4", group = 1)) +


  labs(x = "Time", y = "New positives") +
  scale_x_date(date_breaks = '5 days',
               date_labels = '%Y-%m-%d') +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


```
```{r mod errors, echo =FALSE, message=FALSE, warning=FALSE}
## Model checking - Residual plots
library(modelr)
library(ggplot2)

df$resid <- df$nuovi_positivi - predict(gmod4,type="response")

ggplot(df, aes(data, resid, colour = color)) + 
  geom_ref_line(h = 0) + 
  geom_line()

df %>% 
  ggplot(aes(data, resid)) + 
  geom_ref_line(h = 0) + 
  geom_line(col=1) + 
  geom_smooth(se = FALSE, span = 0.20, col=3)

```
```{r comparison}
AIC(gmod1, gmod2, gmod3, gmod4)
```

```{r glm nuovi tamponi, echo=FALSE, message=FALSE, warning=FALSE}

gmod5 <- glm(nuovi_positivi ~ terapia_intensiva * color + data + terapia_intensiva_prev + nuovi_tamponi, data = df, family=poisson(link = "log"))

summary(gmod5)

ggplot() +
  geom_point(data = df, aes(x = data, y = nuovi_positivi, color="nuovi positivi", group = 1),col=c("#fc6b03","#cfcaca","#f2d729","#b3190b")[unclass(as.factor(df$color))])+ 
geom_line(data = df, aes(x = data, y = predict(gmod5,type="response"), color = "model 4", group = 1)) +


  labs(x = "Time", y = "New positives") +
  scale_x_date(date_breaks = '5 days',
               date_labels = '%Y-%m-%d') +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```
```{r gmod5 predictions, echo=FALSE, message=FALSE, warning=FALSE}

ggplot() +
  geom_point(data = df_extended, aes(x = data, y = nuovi_positivi, color="nuovi positivi", group = 1),col=c("#fc6b03","#cfcaca","#f2d729","#b3190b")[unclass(as.factor(df_extended$color))])+ 
geom_line(data = df_extended, aes(x = data, y = predict(gmod5, newdata=df_extended, type="response"), color = "model 4", group = 1)) +


  labs(x = "Time", y = "New positives") +
  scale_x_date(date_breaks = '5 days',
               date_labels = '%Y-%m-%d') +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```
```{r correlation, echo=FALSE, message=FALSE, warning=FALSE}
library("ggcorrplot")
library("corrplot")
M=cor(df[,c("ricoverati_con_sintomi","nuovi_decessi", "terapia_intensiva","nuovi_tamponi", "nuovi_positivi")])
corrplot(M, method="number")

```

```{r glm6, echo=FALSE, message=FALSE, warning=FALSE}

gmod6 <- glm(nuovi_positivi ~ terapia_intensiva * color + data + terapia_intensiva_prev*color + nuovi_tamponi*color, data = df, family=poisson(link = "log"))

summary(gmod6)

ggplot() +
  geom_point(data = df, aes(x = data, y = nuovi_positivi, color="nuovi positivi", group = 1),col=c("#fc6b03","#cfcaca","#f2d729","#b3190b")[unclass(as.factor(df$color))])+ 
geom_line(data = df, aes(x = data, y = predict(gmod6,type="response"), color = "model 4", group = 1)) +


  labs(x = "Time", y = "New positives") +
  scale_x_date(date_breaks = '5 days',
               date_labels = '%Y-%m-%d') +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

```{r gmod6 predictions, echo=FALSE, message=FALSE, warning=FALSE}

ggplot() +
  geom_point(data = df_extended, aes(x = data, y = nuovi_positivi, color="nuovi positivi", group = 1),col=c("#fc6b03","#cfcaca","#f2d729","#b3190b")[unclass(as.factor(df_extended$color))])+ 
geom_line(data = df_extended, aes(x = data, y = predict(gmod6, newdata=df_extended, type="response"), color = "model 4", group = 1)) +


  labs(x = "Time", y = "New positives") +
  scale_x_date(date_breaks = '5 days',
               date_labels = '%Y-%m-%d') +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

```{r glm6, echo=FALSE, message=FALSE, warning=FALSE}

gmod6 <- glm(nuovi_positivi ~ terapia_intensiva * color + data + terapia_intensiva_prev*color + nuovi_tamponi*color, data = df, family=poisson(link = "log"))

summary(gmod6)

ggplot() +
  geom_point(data = df, aes(x = data, y = nuovi_positivi, color="nuovi positivi", group = 1),col=c("#fc6b03","#cfcaca","#f2d729","#b3190b")[unclass(as.factor(df$color))])+ 
geom_line(data = df, aes(x = data, y = predict(gmod6,type="response"), color = "model 4", group = 1)) +


  labs(x = "Time", y = "New positives") +
  scale_x_date(date_breaks = '5 days',
               date_labels = '%Y-%m-%d') +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

```{r comparison}
AIC(gmod1, gmod2, gmod3, gmod4, gmod5, gmod6)
```