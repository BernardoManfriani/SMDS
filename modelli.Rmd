---
title: "Covid-19 - SMSD models"
output:
  html_document: default
---
  
#### Goal
  
Build up a useful model in order to predict response variable Y starting from data provided.

-   response variable: number of new positives
-   data: Covid-19 spreading outbreak from the official website of Protezione Civile

#### Dataset

Load dataset.

```{r dataset, echo=FALSE, message=FALSE}
df_global <- data.frame(read.csv("https://raw.githubusercontent.com/pcm-dpc/
COVID-19/master/dati-regioni/dpc-covid19-ita-regioni.csv"))

```

#### Clean dataset

Read data we are interested in, then those that are relative to the following couple of parameters:
  
-   regione: Sicilia

-   data: 1st October 2020 to 1st February 2021

```{r df, echo=FALSE, message=FALSE}
df_global <- data.frame(read.csv("https://raw.githubusercontent.com/pcm-dpc/
COVID-19/master/dati-regioni/dpc-covid19-ita-regioni.csv"))

df_sicily_secondwave <- df_global[which(df_global$denominazione_regione == "Sicilia" & 
                                          (df_global$data >= "2020-09-24T10:00:00" & df_global$data <= "2021-02-01T10:00:00")), ]

df <- df_sicily_secondwave[ , -which(names(df_sicily_secondwave) %in% c("stato", "codice_regione", "denominazione_regione", "lat", "long", "note"))]
df <- df[ , -c(17:24)]

df$data <- as.Date(df$data,  "%Y-%m-%d")


# add columns accounting for:  

df$nuovi_tamponi <-NA
df$nuovi_decessi <-NA
df$nuovi_dimessi <- NA
df$terapia_intensiva_prev <- NA
for(x in 8:nrow(df)) {
  df$nuovi_tamponi[x] <- df$tamponi[x] - df$tamponi[x-1] # the number of new swabs carried out
  df$nuovi_decessi[x] <- df$deceduti[x] - df$deceduti[x-1] # daily deaths
  df$nuovi_dimessi[x] <- df$dimessi_guariti[x] - df$dimessi_guariti[x-1] # variation in the number of people discharged from the hospital
  df$terapia_intensiva_prev[x] <- df_sicily_secondwave$terapia_intensiva[x-7]
}

#index reordering
row.names(df) <- NULL 

# remove first row
df <- df[-c(1:7),]

#add color
df$color <-NA
df$color[1:36]<- "bianco"
df$color[c(37:59, 89:91, 101:108)]<- "arancione"
df$color[c(60:84,99,100)]<- "giallo"
df$color[c(85:88,92:95,96,97,98, 109:123)]<- "rosso"

library(ggplot2)

ggplot() +
  geom_line(data = df, aes(x = data, y = nuovi_positivi, color="nuovi positivi", group = 1)) +
  geom_point(data = df, aes(x = data, y = nuovi_positivi, color="nuovi positivi", group = 1),col=c("#fc6b03","#cfcaca","#f2d729","#b3190b")[unclass(as.factor(df$color))])+ 
  labs(x = "Time", y = "New positives") +
  scale_x_date(date_breaks = '5 days',
               date_labels = '%Y-%m-%d') +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


```

```{r adjust color, echo=FALSE, message=FALSE, warning=FALSE}
library(ggplot2)

#adjust color
df$color <-NA
df$color[1:36]<- "bianco"
df$color[c(37:59)]<- "arancione"
df$color[c(60:84)]<- "giallo"
df$color[c(85:95,96:100, 101:123)]<- "rosso"

ggplot() +
  geom_line(data = df, aes(x = data, y = nuovi_positivi, color="nuovi positivi", group = 1)) +
  geom_point(data = df, aes(x = data, y = nuovi_positivi, color="nuovi positivi", group = 1),col=c("#fc6b03","#cfcaca","#f2d729","#b3190b")[unclass(as.factor(df$color))])+ 
  labs(x = "Time", y = "New positives") +
  scale_x_date(date_breaks = '5 days',
               date_labels = '%Y-%m-%d') +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

```{r linear models, echo=FALSE, message=FALSE, warning=FALSE}
# Try some linear models to see which are the variables which significantly explain the variability of y
mod1 <- lm(nuovi_positivi ~ terapia_intensiva, data = df)
mod2 <- lm(nuovi_positivi ~ terapia_intensiva + color, data = df)
mod3 <- lm(nuovi_positivi ~ terapia_intensiva * color, data = df)
mod4 <- lm(nuovi_positivi ~ terapia_intensiva * color + data , data = df)

summary(mod1)
summary(mod2)
summary(mod3)
summary(mod4)

ggplot() +
  geom_line(data = df, aes(x = data, y = nuovi_positivi, color="nuovi positivi", group = 1)) +
  geom_point(data = df, aes(x = data, y = nuovi_positivi, color="nuovi positivi", group = 1),col=c("#fc6b03","#cfcaca","#f2d729","#b3190b")[unclass(as.factor(df$color))])+ 
geom_line(data = df, aes(x = data, y = predict(mod1), color = "model 1", group = 1)) +
  geom_line(data = df, aes(x = data, y = predict(mod2), color = "model 2", group = 1)) +
  geom_line(data = df, aes(x = data, y = predict(mod3), color = "model 3", group = 1)) +
  geom_line(data = df, aes(x = data, y = predict(mod3), color = "model 4", group = 1)) +

  labs(x = "Time", y = "New positives") +
  scale_x_date(date_breaks = '5 days',
               date_labels = '%Y-%m-%d') +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

```{r glm, echo=FALSE, message=FALSE, warning=FALSE}

gmod1 <- glm(nuovi_positivi ~ terapia_intensiva * color, data = df, family=poisson(link = "log"))
gmod2 <- glm(nuovi_positivi ~ terapia_intensiva * color + data, data = df, family=poisson(link = "log"))

summary(gmod1)
summary(gmod2)

ggplot() +
  geom_line(data = df, aes(x = data, y = nuovi_positivi, color="nuovi positivi", group = 1)) +
  geom_point(data = df, aes(x = data, y = nuovi_positivi, color="nuovi positivi", group = 1),col=c("#fc6b03","#cfcaca","#f2d729","#b3190b")[unclass(as.factor(df$color))])+ 
geom_line(data = df, aes(x = data, y = predict(gmod1,type="response"), color = "model 1", group = 1)) +
geom_line(data = df, aes(x = data, y = predict(gmod2,type="response"), color = "model 2", group = 1)) +


  labs(x = "Time", y = "New positives") +
  scale_x_date(date_breaks = '5 days',
               date_labels = '%Y-%m-%d') +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


```


```{r glm mod2 errors, echo =FALSE, message=FALSE, warning=FALSE}
## Model checking - Residual plots
library(modelr)
library(ggplot2)

df$resid <- df$nuovi_positivi -  predict(gmod2,type="response")

ggplot(df, aes(data, resid, colour = color)) + 
  geom_ref_line(h = 0) + 
  geom_line()

df %>% 
  ggplot(aes(data, resid)) + 
  geom_ref_line(h = 0) + 
  geom_line(col=1) + 
  geom_smooth(se = FALSE, span = 0.20, col=3)

```


```{r glm prev data, echo=FALSE, message=FALSE, warning=FALSE}

gmod3 <- glm(nuovi_positivi ~ terapia_intensiva * color + terapia_intensiva_prev, data = df, family=poisson(link = "log"))
gmod4 <- glm(nuovi_positivi ~ terapia_intensiva * color + data + terapia_intensiva_prev, data = df, family=poisson(link = "log"))

summary(gmod3)
summary(gmod4)

ggplot() +
  geom_line(data = df, aes(x = data, y = nuovi_positivi, color="nuovi positivi", group = 1)) +
  geom_point(data = df, aes(x = data, y = nuovi_positivi, color="nuovi positivi", group = 1),col=c("#fc6b03","#cfcaca","#f2d729","#b3190b")[unclass(as.factor(df$color))])+ 
geom_line(data = df, aes(x = data, y = predict(gmod3,type="response"), color = "model 3", group = 1)) +
geom_line(data = df, aes(x = data, y = predict(gmod4,type="response"), color = "model 4", group = 1)) +


  labs(x = "Time", y = "New positives") +
  scale_x_date(date_breaks = '5 days',
               date_labels = '%Y-%m-%d') +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


```
```{r mod errors, echo =FALSE, message=FALSE, warning=FALSE}
## Model checking - Residual plots
library(modelr)
library(ggplot2)

df$resid <- df$nuovi_positivi -  predict(gmod4,type="response")

ggplot(df, aes(data, resid, colour = color)) + 
  geom_ref_line(h = 0) + 
  geom_line()

df %>% 
  ggplot(aes(data, resid)) + 
  geom_ref_line(h = 0) + 
  geom_line(col=1) + 
  geom_smooth(se = FALSE, span = 0.20, col=3)

```

```{r comparison}
AIC(gmod1, gmod2, gmod3, gmod4)
```